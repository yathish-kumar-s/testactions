name: Push to QA

on:
  push:
    branches:
      - dev

jobs:
  push-to-qa:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Fetch All Branches
        run: git fetch --all

      - name: Ensure QA Branch Exists
        run: |
          if git ls-remote --exit-code --heads origin qa; then
            echo "QA branch exists. Checking out."
            git checkout qa
            git pull origin qa
          else
            echo "QA branch does not exist. Creating it."
            git checkout -b qa
            git push origin qa
          fi

      - name: Merge dev into qa
        run: |
          echo "Merging dev into qa..."
          git merge origin/dev --no-edit --strategy-option theirs || (
            echo "Merge conflict detected. Resolving with 'theirs' strategy." &&
            git checkout --theirs . &&
            git add . &&
            git commit -m "Resolved merge conflict"
          )

      - name: Push Changes to QA
        run: |
          # Push only if there are changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "Changes detected. Pushing to QA branch."
            git push origin qa
          else
            echo "No changes to push. QA branch is already up to date."
          fi

      - name: Debug Branch State
        run: |
          echo "Current branch:"
          git branch
          echo "Status of QA branch:"
          git status
          echo "Latest commits on dev:"
          git log origin/dev --oneline -5
          echo "Latest commits on qa:"
          git log origin/qa --oneline -5
